---
- name: Create proxitok network
  community.docker.docker_network:
    name: proxitok
    state: present
  tags:
    - setup

- name: Deploy proxitok signer
  community.docker.docker_container:
    name: proxitok-signer
    image: ghcr.io/pablouser1/signtok:latest@sha256:b03fe2d10dfd6bed717c0f4a7d253908963a5e7f7ea9bf48855a3f74c924f3a7
    pull: true
    recreate: true
    restart_policy: unless-stopped
    user: nobody
    read_only: true
    security_opts:
      - no-new-privileges:true
    cap_drop:
      - ALL
    networks:
      - name: proxitok
  tags:
    - setup
    - update

- name: Deploy valkey
  community.docker.docker_container:
    name: proxitok-valkey
    image: valkey/valkey:8.1.4-alpine
    pull: true
    recreate: true
    command: valkey-server --save 60 1 --loglevel warning
    restart_policy: unless-stopped
    user: nobody
    read_only: true
    security_opts:
      - no-new-privileges:true
    tmpfs:
      - /data:size=10M,mode=0770,uid=65534,gid=65534,noexec,nosuid,nodev
    cap_drop:
      - ALL
    networks:
      - name: proxitok
  tags:
    - setup
    - update

- name: Deploy proxitok
  community.docker.docker_container:
    name: proxitok
    image: ghcr.io/pablouser1/proxitok:latest@sha256:1cbbff4b5b1c6ba8d585379ad71fc93950e340c3a5ae46dd3574e751a873bf8e
    pull: true
    recreate: true
    restart_policy: unless-stopped
    env:
      LATTE_CACHE: /cache
      API_CACHE: redis
      REDIS_HOST: proxitok-valkey
      REDIS_PORT: "6379"
      API_SIGNER: remote
      API_SIGNER_URL: http://proxitok-signer:8080/signature
    security_opts:
      - no-new-privileges:true
    cap_drop:
      - ALL
    capabilities:
      - CHOWN
      - SETGID
      - SETUID
    networks:
      - name: core
      - name: proxitok
    labels: traefik.enable=true traefik.http.routers.proxitok.rule=Host(`proxitok.{{ domain }}`) traefik.http.routers.proxitok.entrypoints=websecure traefik.http.routers.proxitok.tls.certresolver=letsencrypt
      traefik.http.services.proxitok.loadbalancer.server.port=8080
  tags:
    - setup
    - update
